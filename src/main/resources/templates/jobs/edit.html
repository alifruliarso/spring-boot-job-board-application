<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title>[[#{jobPost.edit.headline}]]</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="d-flex flex-wrap mb-4">
            <h1 class="flex-grow-1">[[#{jobPost.edit.headline}]]</h1>
            <div>
                <a th:href="@{/jobs}" class="btn btn-secondary">[[#{jobPost.edit.back}]]</a>
            </div>
        </div>
        <div th:replace="~{fragments/forms::globalErrors('jobPost')}" />
        <form th:action="${requestUri}" method="post" novalidate="">
            <div class="row">
                <div class="col-lg-8">
                    <div th:replace="~{fragments/forms::inputRow(object='jobPost', field='id', disabled=true)}" />
                    <div th:replace="~{fragments/forms::inputRow(object='jobPost', field='title', required=true)}" />
                    <div
                        th:replace="~{fragments/forms::inputRow(object='jobPost', field='description', required=true, type='textarea')}" />
                    <div
                        th:replace="~{fragments/forms::inputRow(object='jobPost', field='jobType', required=true, type='select')}" />
                    <div
                        th:replace="~{fragments/forms::inputRow(object='jobPost', field='maximumMonthlySalary', required=true)}" />
                    <div
                        th:replace="~{fragments/forms::inputRow(object='jobPost', field='datePosted', required=true, inputClass='js-datetimepicker')}" />
                    <div
                        th:replace="~{fragments/forms::inputRow(object='jobPost', field='companyId', required=true, type='select')}" />
                    <div
                        th:replace="~{fragments/forms::inputRow(object='jobPost', field='workModel', required=true, type='radio')}" />
                    <div th:replace="~{fragments/forms::inputRow(object='jobPost', field='location')}" />
                    <div th:replace="~{fragments/forms::inputRow(object='jobPost', field='applyUrl')}" />
                    <input type="submit" th:value="#{jobPost.edit.headline}" class="btn btn-primary mt-4" />
                </div>
                <div class="col-lg-4">
                    <h3 class="h5 mb-4">Skills</h3>
                    <div id="skillsDiv" class="skills-container">
                        <span th:each="item : ${jobPost.skills}" th:text="${item.name}" class="skill-tag"></span>
                        <input type="hidden" name="skillsIds" th:each="item, iterStat : ${jobPost.skills}"
                            th:value="${item.id}" />
                    </div>
                    <div class="d-flex align-items-center mt-3">
                        <button sec:authorize="hasRole('ADMIN')" id="btnExtract"
                            class="btn btn-create btn-md text-white" th:data-jobid="${jobPost.id}"><i
                                class="bi bi-plus-circle me-1"></i>Extract skills from
                            description using Spring AI</button>
                    </div>
                </div>
            </div>
        </form>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script th:inline="javascript">
            let jobId = /*[[${jobPost.id}]]*/ 'default value';

            $(document).ready(function () {
                $(document).on('click', '#btnExtract', function (event) {
                    event.preventDefault();
                    var $btn = $(this);
                    // Show spinner inside the button
                    var originalHtml = $btn.html();
                    $btn.html('<span class="spinner-border spinner-border-sm me-2 text-primary" role="status" aria-hidden="true"></span>Extracting...');
                    $btn.prop('disabled', true);

                    var url = "/jobs/skills/extract/" + jobId;
                    console.log("=url=: ", url);
                    $('#skillsDiv').load(url, function (responseText, textStatus, jqXHR) {
                        if (textStatus === "success") {
                            // Restore button after load completes
                            $btn.html(originalHtml);
                            $btn.prop('disabled', false);
                        } else {
                            // Handle error
                            $btn.html('<i class="bi bi-exclamation-circle me-1"></i>Error, try again');
                            setTimeout(function () {
                                $btn.html(originalHtml);
                                $btn.prop('disabled', false);
                            }, 2000);
                            // Optionally show an alert
                            alert("Failed to extract skills: " + jqXHR.status + " " + jqXHR.statusText);
                        }
                    });
                });
            });
        </script>
    </div>
</body>

</html>